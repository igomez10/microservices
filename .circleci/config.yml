version: 2.1
orbs:
  slack: circleci/slack@4.9.3
  jira: circleci/jira@1.3.1
  gcp-gcr: circleci/gcp-gcr@0.15.0
jobs:
  build-bitcoin-service:
    docker:
      - image: circleci/golang:1.16
      - image: circleci/postgres:9.6-alpine
        environment:
          POSTGRES_USER: postgres
          POSTGRES_DB: bitcoinprice_test

    environment:
      TEST_RESULTS: /tmp/test-results

    steps:
      - checkout
      - run: git rev-parse HEAD
      - run: cd bitcoinprice &&
          mkdir -p $TEST_RESULTS

      - restore_cache:
          keys:
            - v1-pkg-cache
      - run: cd bitcoinprice &&
          go mod download &&
          go get github.com/jstemmer/go-junit-report

      - run:
          name: Setup Buffalo
          command: |
            wget https://github.com/gobuffalo/cli/releases/download/v0.18.2/buffalo_0.18.2_Linux_x86_64.tar.gz &&
            tar -xvzf buffalo_0.18.2_Linux_x86_64.tar.gz &&
            sudo mv buffalo /usr/local/bin/buffalo

      - run:
          name: Run unit tests
          command: |
            trap "go-junit-report <${TEST_RESULTS}/go-test.out > ${TEST_RESULTS}/go-test-report.xml" EXIT
            cd bitcoinprice && buffalo test | tee ${TEST_RESULTS}/go-test.out

      - save_cache:
          key: v1-pkg-cache
          paths:
            - "/go/pkg"

      - store_artifacts:
          path: /tmp/test-results
          destination: raw-test-output

      - store_test_results:
          path: /tmp/test-results

      # slack notifications
      - slack/notify:
          event: fail
          template: basic_fail_1
      - slack/notify:
          event: pass
          template: success_tagged_deploy_1

  notify:
    docker:
      - image: "cimg/base:stable"
    steps:
      - slack/notify:
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "plain_text",
                      "text": "*This is a text notification*",
                      "emoji": true
                    }
                  ]
                }
              ]
            }
          event: always
  build-and-push:
    executor: gcp-gcr/default
    steps:
      - checkout
      - gcp-gcr/gcr-auth
      - gcp-gcr/build-image:
          image: orb-test
          no_output_timeout: 20m
          registry-url: us-central1-docker.pkg.dev
      - gcp-gcr/push-image:
          digest-path: /tmp/digest.txt
          image: orb-test
          registry-url: us-central1-docker.pkg.dev
      - run:
          command: |
            echo "Digest is: $(</tmp/digest.txt)"
workflows:
  send-notification-slack:
    jobs:
      - notify:
          context: slack
  send-notification-jira:
    jobs:
      - build-bitcoin-service:
          context: slack
          post-steps:
            - jira/notify
